<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Spejderpost</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
        <style type="text/css">
            body {
                padding: 0;
                margin: 0;
            }
            html, body {
                height: 100%;
                width: 100vw;
            }
            #mapid {
              height: 90vh;
            }
            #hidden_iframe {
              display: None;
            };
        </style>
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css"
  integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
  crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js"
  integrity="sha512-QVftwZFqvtRNi0ZyCtsznlKSWOStnDORoefr1enyq5mVL4tmKB3S/EnC3rRJcxCPavG10IcrVGSmPh6Qw5lwrg=="
  crossorigin=""></script>
    </head>
    <body>
        <label for="ansvarlig">Navn</label>: <input id="ansvarlig">
        <input type="button" id="refreshButton" value="Refresh">
        <iframe id="hidden_iframe" name="hidden_iframe"></iframe>
        <div id='mapid'></div>

        <script>
            const ansvarligInput = document.getElementById('ansvarlig');
            const refreshButton = document.getElementById('refreshButton');
            const backend = 'https://script.google.com/macros/s/AKfycbxsnpd2ED5Iz4VOFJmmCsu5X4n1Ukz3Bc9suHEj2NiNbWWBmUA/exec';

            // from mdn
            function postData(url = ``, data = {}) {
            // Default options are marked with *
                return fetch(url, {
                    method: "POST", // *GET, POST, PUT, DELETE, etc.
                    mode: "cors", // no-cors, cors, *same-origin
                    cache: "no-cache", // *default, no-cache, reload, force-cache, only-if-cached
                    credentials: "same-origin", // include, *same-origin, omit
                    headers: {
                        "Content-Type": "application/json",
                        // "Content-Type": "application/x-www-form-urlencoded",
                    },
                    redirect: "follow", // manual, *follow, error
                    referrer: "no-referrer", // no-referrer, *client
                    body: JSON.stringify(data), // body data type must match "Content-Type" header
                })
                .then(response => response.json()); // parses JSON response into native Javascript objects 
            }

            // Called with layer as arg
            function makeForm(layer) {
                console.log('makeForm called for '+layer);
                const props = layer.feature.properties;
                console.log('props: '+props);
                var ny_handling = '';
                var msg = 'Rute '+props.rute+'<br>';
                switch (props.tilstand) {
                    case 'fri': ny_handling = 'reserver'; break;
                    case 'reserveret': msg = msg+'Reserveret af '+props.ansvarlig+'.<br>'; ny_handling = 'afslut'; break;
                }
                if (!Boolean(ny_handling)) {
                    return msg+'Afsluttet af '+props.ansvarlig;
                }
                const formstring = 
                    '<form method="post" action="'+backend+'" target="hidden_iframe">'
                    + '<input type="hidden" name="ansvarlig" value="'+ansvarligInput.value+'">'
                    + '<input type="hidden" name="rute" value="'+props.rute+'">'
                    + '<input type="hidden" name="handling" value="'+ny_handling+'">'
                    + '<input type="submit" value="'+ny_handling+'">'
                    + '</form>';
                return msg+formstring;
            }

            var mymap = L.map('mapid').setView([55.521, 9.6353], 15);
            L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
                attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
                maxZoom: 18,
                id: 'mapbox.streets',
                accessToken: 'pk.eyJ1IjoiamFudXN3ZXNlbmJlcmciLCJhIjoiY2p0bmpzd2U2MHExMDQ1bGk5eng2dWM1bSJ9.UTP4V82VDD95-aRN5Zi2Rw'
            }).addTo(mymap);


            // geojson created with geojson.io
            const data = {"type":"FeatureCollection","features":[{"type":"Feature","properties":{"stroke":"#555555","stroke-width":2,"stroke-opacity":1,"fill":"#555555","fill-opacity":0.5,"rute":"Rute01"},"geometry":{"type":"Polygon","coordinates":[[[9.635331630706785,55.520686942143016],[9.633979797363281,55.518391021536765],[9.633078575134277,55.51829383675702],[9.632391929626465,55.51709115524441],[9.633405804634094,55.51687248192943],[9.63350772857666,55.51654143251543],[9.634097814559935,55.516681141782094],[9.635438919067383,55.51888908976588],[9.636576175689697,55.520541173388764],[9.635331630706785,55.520686942143016]]]}},{"type":"Feature","properties":{"stroke":"#555555","stroke-width":2,"stroke-opacity":1,"fill":"#555555","fill-opacity":0.5,"rute":"Rute02"},"geometry":{"type":"Polygon","coordinates":[[[9.633303880691528,55.515147349841016],[9.631898403167725,55.51419363520728],[9.63199496269226,55.51405695446514],[9.631201028823853,55.513683358014724],[9.630841612815857,55.513671208477106],[9.630605578422546,55.513385693263835],[9.63077187538147,55.51324293488049],[9.63225781917572,55.51397190843044],[9.632536768913269,55.513895974315616],[9.633700847625732,55.5142452700308],[9.634666442871094,55.51457026412961],[9.63500440120697,55.515004597847486],[9.634897112846375,55.51533869744569],[9.634661078453064,55.51576998546046],[9.63500440120697,55.515994739313136],[9.635310173034668,55.51660217573578],[9.635063409805298,55.51683907339932],[9.634661078453064,55.516726699044405],[9.634124636650085,55.51662039868362],[9.633462131023407,55.516511060870094],[9.633153676986694,55.5164396874113],[9.633421897888184,55.516186082797816],[9.632037878036499,55.51523846786403],[9.632456302642822,55.514612786523465],[9.633303880691528,55.515147349841016]]]}},{"type":"Feature","properties":{"stroke":"#555555","stroke-width":2,"stroke-opacity":1,"fill":"#555555","fill-opacity":0.5,"rute":"Rute03"},"geometry":{"type":"Polygon","coordinates":[[[9.637134075164795,55.51058510446611],[9.6384859085083,55.512109961689944],[9.640781879425049,55.513671208477106],[9.639708995819092,55.51395672161921],[9.637295007705688,55.51501370969231],[9.633314609527586,55.514059991820126],[9.634100496768951,55.513290014830076],[9.634105861186981,55.51292096726408],[9.637134075164795,55.51058510446611]]]}},{"type":"Feature","properties":{"stroke":"#555555","stroke-width":2,"stroke-opacity":1,"fill":"#555555","fill-opacity":0.5,"rute":"Rute04"},"geometry":{"type":"Polygon","coordinates":[[[9.634376764297485,55.511860885462845],[9.634591341018675,55.51204921153599],[9.633883237838745,55.5126445590017],[9.6340012550354,55.51323989746245],[9.633486270904541,55.513671208477106],[9.632239043712616,55.5139020490502],[9.632110297679901,55.51387319405259],[9.631804525852203,55.51418452317258],[9.632102251052856,55.514521667051824],[9.631914496421814,55.51529010131676],[9.63323414325714,55.516262012494195],[9.633035659790039,55.516556618329325],[9.632670879364014,55.51637438817603],[9.631962776184082,55.51643209448252],[9.631399512290955,55.51615267368497],[9.630981087684631,55.515420703277194],[9.631260037422178,55.51492866572506],[9.631394147872925,55.514202747239906],[9.630568027496338,55.51443358469542],[9.629677534103394,55.51411770152024],[9.630787968635559,55.51372588136677],[9.631131291389465,55.51372588136677],[9.631479978561401,55.51399316995634],[9.631737470626831,55.514002282035364],[9.631952047348022,55.513771442050164],[9.631662368774414,55.513577049433536],[9.632177352905273,55.51312751283027],[9.632552862167358,55.512665821244646],[9.634376764297485,55.511860885462845]]]}},{"type":"Feature","properties":{"stroke":"#555555","stroke-width":2,"stroke-opacity":1,"fill":"#555555","fill-opacity":0.5,"rute":"Rute05"},"geometry":{"type":"Polygon","coordinates":[[[9.628121852874756,55.520510804830316],[9.62846517562866,55.52107565618093],[9.629430770874023,55.52122142295512],[9.631211757659912,55.52086307866724],[9.631726741790771,55.52229643623781],[9.623712301254272,55.52350503191666],[9.623583555221558,55.521901660761216],[9.62478518486023,55.521640499422915],[9.628121852874756,55.520510804830316]]]}},{"type":"Feature","properties":{"stroke":"#555555","stroke-width":2,"stroke-opacity":1,"fill":"#555555","fill-opacity":0.5,"rute":"Rute06"},"geometry":{"type":"Polygon","coordinates":[[[9.622650146484375,55.51867042644159],[9.624066352844237,55.518524650217024],[9.625225067138672,55.51953292472036],[9.626469612121582,55.51949648151361],[9.627209901809692,55.520450067643125],[9.623551368713379,55.52169516124182],[9.623143672943115,55.52185307273652],[9.623143672943115,55.5238208397448],[9.624452590942383,55.52384513254966],[9.625010490417479,55.52839976839139],[9.62277889251709,55.531994521903734],[9.619925022125244,55.531994521903734],[9.621233940124512,55.522970582124856],[9.622650146484375,55.51867042644159]]]}},{"type":"Feature","properties":{"stroke":"#555555","stroke-width":2,"stroke-opacity":1,"fill":"#555555","fill-opacity":0.5,"rute":"Rute07"},"geometry":{"type":"Polygon","coordinates":[[[9.636565446853638,55.51858235337049],[9.637413024902344,55.518412280675335],[9.638072848320007,55.51916545417355],[9.6389901638031,55.519803210783444],[9.637155532836914,55.5201888966699],[9.636543989181519,55.520061347425035],[9.635838568210602,55.51881923911382],[9.634194374084473,55.51908649311226],[9.634183645248413,55.52035288794863],[9.63252067565918,55.520838784021116],[9.630943536758423,55.52082663669243],[9.629420042037964,55.521118171545865],[9.628744125366211,55.520319482373225],[9.627435207366943,55.52052295225653],[9.627145528793335,55.52007956877105],[9.628754854202269,55.520198007314434],[9.629479050636292,55.520128158985806],[9.63400661945343,55.51910167794405],[9.635851979255676,55.51874331435137],[9.636565446853638,55.51858235337049]]]}},{"type":"Feature","properties":{"stroke":"#555555","stroke-width":2,"stroke-opacity":1,"fill":"#555555","fill-opacity":0.5,"rute":"Rute08"},"geometry":{"type":"Polygon","coordinates":[[[9.637976288795471,55.517962799299816],[9.637117981910706,55.518412280675335],[9.635680317878723,55.51870383341699],[9.634940028190613,55.517832205775484],[9.634382128715513,55.517012190020836],[9.63426411151886,55.516723661895234],[9.63502049446106,55.51692715037209],[9.635385274887085,55.5165869899395],[9.636710286140442,55.51632579332596],[9.637976288795471,55.517962799299816]]]}},{"type":"Feature","properties":{"stroke":"#555555","stroke-width":2,"stroke-opacity":1,"fill":"#555555","fill-opacity":0.5,"rute":"Rute09"},"geometry":{"type":"Polygon","coordinates":[[[9.6387380361557,55.51678440483432],[9.639902114868164,55.51658091561932],[9.640116691589355,55.517006115766314],[9.642927646636963,55.51632579332596],[9.645116329193115,55.51879190621622],[9.643667936325073,55.51898931005012],[9.642884731292725,55.51913508455336],[9.642053246498108,55.51895286633993],[9.639387130737305,55.518069096034566],[9.63926374912262,55.51817842951931],[9.640057682991026,55.51848820607649],[9.638915061950684,55.519611884885805],[9.638088941574097,55.519077382210405],[9.637568593025208,55.51843961383664],[9.638362526893616,55.517944576973605],[9.639033079147339,55.51810250352047],[9.639135003089905,55.5179901327733],[9.63851273059845,55.51777146445372],[9.63875949382782,55.51747383062177],[9.6387380361557,55.51678440483432]]]}},{"type":"Feature","properties":{"stroke":"#555555","stroke-width":2,"stroke-opacity":1,"fill":"#555555","fill-opacity":0.5,"rute":"Rute10"},"geometry":{"type":"Polygon","coordinates":[[[9.645883440971375,55.519763730912494],[9.648549556732178,55.519071308274626],[9.649043083190918,55.51652017236616],[9.652862548828125,55.51766212983826],[9.656810760498047,55.51666595601624],[9.658076763153076,55.518378873452434],[9.653162956237793,55.518378873452434],[9.652261734008789,55.51947218602373],[9.652905464172363,55.52391801087424],[9.654879570007324,55.52376010766703],[9.655802249908447,55.524768248019484],[9.661917686462402,55.523966596348956],[9.664020538330076,55.52411235241313],[9.66245412826538,55.525764216734494],[9.655169248580933,55.52572777929903],[9.652862548828125,55.52615895345544],[9.651553630828857,55.526911978676424],[9.64576005935669,55.528351188391426],[9.645620584487915,55.52892199960191],[9.643721580505371,55.52882484083191],[9.643678665161133,55.52768320730802],[9.645309448242188,55.526978778604814],[9.651424884796143,55.52541198677803],[9.65075969696045,55.51983661679715],[9.647283554077148,55.520128158985806],[9.647884368896484,55.52084485768406],[9.646865129470825,55.52098151485226],[9.645883440971375,55.519763730912494]]]}},{"type":"Feature","properties":{"stroke":"#555555","stroke-width":2,"stroke-opacity":1,"fill":"#555555","fill-opacity":0.5,"rute":"Rute11"},"geometry":{"type":"Polygon","coordinates":[[[9.64023470878601,55.51854894629195],[9.64373230934143,55.5196908448928],[9.643828868865967,55.519107751875126],[9.645770788192747,55.51911989973445],[9.644848108291626,55.51963010643993],[9.644687175750732,55.519842690614794],[9.64576005935669,55.52017067537452],[9.64499831199646,55.52168301417751],[9.642863273620605,55.52304346206941],[9.639966487884521,55.522970582124856],[9.639043807983398,55.51964225413801],[9.64023470878601,55.51854894629195]]]}},{"type":"Feature","properties":{"stroke":"#555555","stroke-width":2,"stroke-opacity":1,"fill":"#555555","fill-opacity":0.5,"rute":"Rute12"},"geometry":{"type":"Polygon","coordinates":[[[9.629366397857666,55.51762568489892],[9.630235433578491,55.51975158325191],[9.628679752349854,55.52014030653013],[9.62797164916992,55.52000060954408],[9.627145528793335,55.518014429178265],[9.629366397857666,55.51762568489892]]]}},{"type":"Feature","properties":{"stroke":"#555555","stroke-width":2,"stroke-opacity":1,"fill":"#555555","fill-opacity":0.5,"rute":"Rute13"},"geometry":{"type":"Polygon","coordinates":[[[9.631581902503967,55.51713671203208],[9.632434844970703,55.51727641918543],[9.63302493095398,55.51836065131886],[9.633437991142271,55.51840316961736],[9.633824229240417,55.518473021008],[9.634081721305847,55.51897412517498],[9.63050365447998,55.519672623366795],[9.629570245742798,55.51742523712934],[9.631581902503967,55.51713671203208]]]}},{"type":"Feature","properties":{"stroke":"#555555","stroke-width":2,"stroke-opacity":1,"fill":"#555555","fill-opacity":0.5,"rute":"Rute14"},"geometry":{"type":"Polygon","coordinates":[[[9.629146456718445,55.514494331169246],[9.629725813865662,55.5142148966134],[9.630557298660278,55.514506480452724],[9.631120562553406,55.51471909230704],[9.631147384643555,55.51493777758749],[9.630814790725708,55.51543892677209],[9.631361961364746,55.51633794204412],[9.631952047348022,55.51650954228724],[9.632657468318937,55.51643665023996],[9.633035659790039,55.51659913857699],[9.633258283138275,55.516583952779534],[9.63338166475296,55.51682540626517],[9.631887674331665,55.51712760067876],[9.631351232528687,55.517048635528326],[9.629377126693726,55.51727945629195],[9.628894329071045,55.51659306425873],[9.626641273498535,55.51686033337631],[9.626308679580688,55.51772894547268],[9.62698459625244,55.518506428150985],[9.62576150894165,55.5189316074934],[9.624838829040527,55.518202725807996],[9.625847339630127,55.51684818481945],[9.626823663711548,55.51659913857699],[9.62778925895691,55.515530044120034],[9.629119634628296,55.51482539780348],[9.629146456718445,55.514494331169246]]]}},{"type":"Feature","properties":{"stroke":"#555555","stroke-width":2,"stroke-opacity":1,"fill":"#555555","fill-opacity":0.5,"rute":"Rute15"},"geometry":{"type":"Polygon","coordinates":[[[9.643346071243284,55.511168323766846],[9.641586542129517,55.51058510446611],[9.641886949539185,55.510050479182546],[9.646543264389038,55.512286136606185],[9.645910263061523,55.51291185493472],[9.643410444259644,55.513695507548576],[9.642155170440672,55.51372588136677],[9.640320539474487,55.513889899580114],[9.637477397918701,55.51508660437515],[9.637831449508667,55.51541462877702],[9.638679027557373,55.51475857723922],[9.640610218048096,55.51623467782038],[9.638724625110626,55.516754033376486],[9.638657569885252,55.516538395351965],[9.63802456855774,55.51569405481472],[9.637541770935059,55.51571835263731],[9.638400077819824,55.51688463047881],[9.63823914527893,55.51764998152889],[9.637874364852905,55.51771679718395],[9.63624358177185,55.515481448227376],[9.634977579116821,55.515490559961826],[9.635047316551208,55.514904367414935],[9.634940028190613,55.51458545070413],[9.637311100959778,55.51505926888489],[9.640315175056458,55.5138109279331],[9.642122983932495,55.513634759841814],[9.642595052719116,55.512352961368144],[9.641597270965576,55.51174545935974],[9.643346071243284,55.511168323766846]]]}},{"type":"Feature","properties":{"stroke":"#555555","stroke-width":2,"stroke-opacity":1,"fill":"#555555","fill-opacity":0.5,"rute":"Rute16"},"geometry":{"type":"Polygon","coordinates":[[[9.64600682258606,55.51344644135501],[9.646146297454834,55.51401746882904],[9.643388986587524,55.514709980393974],[9.642938375473022,55.515827692653204],[9.640867710113525,55.516307570241736],[9.63875412940979,55.51460063727276],[9.640556573867798,55.5139020490502],[9.642562866210936,55.51445484597193],[9.643281698226929,55.513853451147334],[9.64600682258606,55.51344644135501]]]}},{"type":"Feature","properties":{"stroke":"#555555","stroke-width":2,"stroke-opacity":1,"fill":"#555555","fill-opacity":0.5,"rute":"Rute17"},"geometry":{"type":"Polygon","coordinates":[[[9.621180295944214,55.5132034484277],[9.62378740310669,55.51365905893578],[9.626287221908568,55.51375625516155],[9.62827205657959,55.51368943278211],[9.630578756332397,55.51323989746245],[9.630557298660278,55.51339784288957],[9.630728960037231,55.5136651337069],[9.629479050636292,55.514055435787554],[9.629540741443634,55.51426197540039],[9.628846049308777,55.51420578458362],[9.628821909427643,55.51398102051437],[9.627952873706818,55.51402809958111],[9.627939462661743,55.51408277197501],[9.628454446792603,55.51410707079236],[9.62891310453415,55.51432727814067],[9.629057943820953,55.51452926034919],[9.629065990447998,55.51481021132157],[9.627660512924194,55.5154753737366],[9.625353813171387,55.514971187731646],[9.625643491744995,55.51447914455955],[9.625149965286255,55.514852733456145],[9.623910784721375,55.514621898459],[9.624490141868591,55.513795741059724],[9.621153473854065,55.51361957290046],[9.621180295944214,55.5132034484277]]]}},{"type":"Feature","properties":{"stroke":"#555555","stroke-width":2,"stroke-opacity":1,"fill":"#555555","fill-opacity":0.5,"rute":"Rute18"},"geometry":{"type":"Polygon","coordinates":[[[9.621003270149231,55.51413896296739],[9.62129294872284,55.51420578458362],[9.621271491050718,55.51439409943717],[9.623159766197205,55.514591525332285],[9.62252676486969,55.51576391101419],[9.621802568435669,55.515991702107456],[9.62076187133789,55.515949181203474],[9.619930386543274,55.51583376708963],[9.619994759559631,55.51538121900927],[9.618203043937683,55.515247579654734],[9.61877703666687,55.51367728324637],[9.619109630584717,55.51363779722938],[9.61925983428955,55.51327027163228],[9.620155692100525,55.5132915335372],[9.619930386543274,55.51384130166223],[9.620847702026367,55.51394760952966],[9.621003270149231,55.51413896296739]]]}}]};

            // patch geojson based on states retrieved from backend
            function patchData(states) {
                var lookup = new Map(states.map(function (s) {return [s.rute, s];}));
                var fs = data.features.map(function (feature) {
                    var row = lookup.get(feature.properties.rute);
                    if (!Boolean(row)) {feature.properties.farve = 'brown'; return feature;}
                    feature.properties.tilstand = row.tilstand;
                    feature.properties.ansvarlig = row.ansvarlig;
                    var farve = 'brown';
                    switch (row.tilstand) {
                        case 'fri':
                            farve = 'red';
                            break;
                        case 'reserveret':
                            farve = 'yellow';
                            break
                        case 'afsluttet':
                            farve = 'green';
                            break;
                    }
                    feature.properties.farve = farve;
                    return feature;
                });
                return {type: 'FeatureCollection', features: fs};
            }

            // https://leafletjs.com/reference-1.4.0.html#geojson
            var geolayer = L
            .geoJSON()
            .bindPopup(makeForm)
            .addTo(mymap);

            function updateOverlay(mergedData) {
                geolayer
                .clearLayers()
                .addData(mergedData)
                .setStyle(function (feature) {return {color: feature.properties.farve};})
                .eachLayer(function (layer) { layer.bindTooltip(layer.feature.properties.rute).openTooltip(); });
            }

            function refresh() {
                //updateOverlay(data);
                fetch(backend)
                .then(function(response) {
                    return response.json();
                })
                .then(function(myJson) {
                    console.log('Bacend json: ' + JSON.stringify(myJson));
                    return patchData(myJson);
                })
                .then(function(patchedData) {
                    updateOverlay(patchedData);
                    console.log('Updated overlay for patched geoJSON: ' + JSON.stringify(patchedData));
                })
            }

            refreshButton.onclick = refresh;

            setInterval(function() {
                console.log('Tick');
            }, 10000);
        </script>
    </body>
</html>


